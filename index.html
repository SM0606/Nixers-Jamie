<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nixer Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1976d2" />

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Nixer Management</h1>
  <div class="container">

    <!-- DASHBOARD -->
    <div class="dashboard">
      <div class="dashboard-card">
        <div class="dash-label">Total jobs</div>
        <div class="dash-value" id="totalJobs">0</div>
      </div>
      <div class="dashboard-card">
        <div class="dash-label">Total profit (€)</div>
        <div class="dash-value" id="totalProfit">0.00</div>
      </div>
      <div class="dashboard-card">
        <div class="dash-label">Jobs this month</div>
        <div class="dash-value" id="jobsThisMonth">0</div>
      </div>
      <div class="dashboard-card">
        <div class="dash-label">Pending / In progress</div>
        <div class="dash-value" id="pendingJobs">0</div>
      </div>
    </div>

    <!-- FORM -->
    <form id="mixerForm">
      <label>Client Name
        <input type="text" id="clientName" required />
      </label>

      <label>Contact
        <input type="text" id="contact" />
      </label>

      <label>Nixer Model
        <input type="text" id="mixerModel" />
      </label>

      <label>Reg / Plate
        <input type="text" id="reg" />
      </label>

      <label>Parts Price (€)
        <input type="number" step="0.01" id="partsPrice" />
      </label>

      <label>Total Price (€)
        <input type="number" step="0.01" id="price" />
      </label>

      <label>Date
        <input type="date" id="date" />
      </label>

      <label>Status
        <select id="status">
          <option value="Pending">Pending</option>
          <option value="In Progress">In Progress</option>
          <option value="Ready for Pickup">Ready for Pickup</option>
          <option value="Completed">Completed</option>
          <option value="Paid">Paid</option>
        </select>
      </label>

      <label class="full-width">
        Work Needed
        <textarea id="workNeeded"></textarea>
      </label>

      <label class="full-width">
        Notes / Work done
        <textarea id="notes"></textarea>
      </label>

      <button type="submit" id="addBtn" class="btn btn-primary">Add / Save</button>
    </form>

    <!-- CONTROLS -->
    <div class="actions">
      <input type="text" id="searchInput"
        placeholder="Search by client, reg, nixer, status..." />

      <div class="right-actions">
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none;">
          Install App
        </button>

        <button id="themeToggle" class="btn btn-outline">Dark mode</button>
        <button id="downloadBtn" class="btn btn-outline">Download CSV</button>
        <button id="clearAllBtn" class="btn btn-danger">Clear ALL records</button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Client</th>
            <th>Contact</th>
            <th>Nixer</th>
            <th>Reg</th>
            <th>Status</th>
            <th>Date</th>
            <th>Parts (€)</th>
            <th>Total (€)</th>
            <th>Profit (€)</th>
            <th>Work Needed</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>

  </div>

  <script>
    const STORAGE_KEY = "mixer_records_v1";
    const THEME_KEY = "mixer_theme_v1";

    const form = document.getElementById("mixerForm");
    const workNeededInput = document.getElementById("workNeeded");
    const notesInput = document.getElementById("notes");
    const recordsBody = document.getElementById("recordsBody");
    const installBtn = document.getElementById("installBtn");

    let records = [];
    let deferredPrompt = null;

    function loadRecords() {
      const saved = localStorage.getItem(STORAGE_KEY);
      records = saved ? JSON.parse(saved) : [];
    }

    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function renderTable() {
      recordsBody.innerHTML = "";

      records.forEach((r, index) => {
        const total = parseFloat(r.price) || 0;
        const parts = parseFloat(r.partsPrice) || 0;
        const profit = total - parts;

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${r.clientName || ""}</td>
          <td>${r.contact || ""}</td>
          <td>${r.mixerModel || ""}</td>
          <td>${r.reg || ""}</td>
          <td>${r.status || ""}</td>
          <td>${r.date || ""}</td>
          <td>${r.partsPrice || ""}</td>
          <td>${r.price || ""}</td>
          <td>${profit.toFixed(2)}</td>
          <td>${r.workNeeded || ""}</td>
          <td>${r.notes || ""}</td>
          <td>
            <button onclick="deleteRecord(${index})">Delete</button>
          </td>
        `;

        recordsBody.appendChild(tr);
      });
    }

    function deleteRecord(index) {
      records.splice(index, 1);
      saveRecords();
      renderTable();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const newRecord = {
        clientName: document.getElementById("clientName").value,
        contact: document.getElementById("contact").value,
        mixerModel: document.getElementById("mixerModel").value,
        reg: document.getElementById("reg").value,
        partsPrice: document.getElementById("partsPrice").value,
        price: document.getElementById("price").value,
        date: document.getElementById("date").value,
        status: document.getElementById("status").value,
        workNeeded: workNeededInput.value,
        notes: notesInput.value
      };

      records.push(newRecord);
      saveRecords();
      renderTable();
      form.reset();
    });

    // INSTALL BUTTON
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = "inline-block";
    });

    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      installBtn.style.display = "none";
      deferredPrompt = null;
    });

    // INIT
    loadRecords();
    renderTable();

    // SERVICE WORKER REGISTER (VERSIONED)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js?v=v2") // MUST MATCH cache version
          .catch(console.error);
      });
    }
  </script>
</body>
</html>
